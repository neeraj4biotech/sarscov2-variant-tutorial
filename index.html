<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>SARS-CoV-2 Variant Calling Tutorial — ICE-Cloud</title>
  <style>
    :root{--accent:#0b63a5;--muted:#6b7280;--bg:#ffffff;--mono:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
    body{font-family:Inter,ui-sans-serif,system-ui, -apple-system,Segoe UI,Roboto,Helvetica,Arial;line-height:1.6;color:#111;margin:0;background:var(--bg)}
    header{background:#f8fafc;border-bottom:1px solid #e6eef6;padding:18px 24px;display:flex;align-items:center;gap:16px}
    header h1{font-size:18px;margin:0;color:var(--accent)}
    .container{display:flex;min-height:calc(100vh - 66px)}
    nav{width:280px;border-right:1px solid #eef3f7;padding:20px 18px;background:#fbfdff;position:sticky;top:66px;align-self:flex-start;height:calc(100vh - 66px);overflow:auto}
    nav h2{font-size:13px;margin:0 0 12px 0;color:#0f1724}
    nav ul{list-style:none;padding:0;margin:0}
    nav li{margin:6px 0}
    nav a{color:#0b63a5;text-decoration:none;font-size:14px}
    main{flex:1;padding:28px 36px;max-width:980px}
    section{margin-bottom:32px}
    h2.section-title{font-size:20px;margin:0 0 12px 0}
    p.lead{color:var(--muted);margin-top:6px}
    pre{background:#0b1220;color:#ecf2ff;padding:14px;border-radius:6px;overflow:auto;font-family:var(--mono);font-size:13px}
    .cmd-wrap{position:relative;margin:12px 0}
    .copy-btn{position:absolute;right:8px;top:8px;background:var(--accent);border:none;color:white;padding:6px 8px;border-radius:4px;cursor:pointer;font-size:12px}
    .meta{background:#f1f6fb;border-left:4px solid var(--accent);padding:10px 12px;margin:12px 0;border-radius:4px}
    .footnote{font-size:13px;color:var(--muted)}
    a.external{color:var(--accent)}
    .doc-links{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
    .card{border:1px solid #eef4fa;padding:10px;border-radius:6px;background:white}
    .top-actions{display:flex;gap:8px;margin-left:auto}
    .btn{background:var(--accent);color:white;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
    .small{font-size:13px;padding:6px 8px}
    .download{background:#2b6cb0}
    footer{border-top:1px solid #eef3f7;padding:18px 36px;color:var(--muted);font-size:13px}
    code.inline{background:#f3f6fb;padding:2px 6px;border-radius:4px;font-family:var(--mono)}
    @media (max-width:800px){nav{display:none} .container{padding:0} main{padding:18px}}
  </style>
</head>
<body>
  <header>
    <h1>SARS-CoV-2 Variant Calling Tutorial — ICE-Cloud</h1>
    <div class="top-actions">
      <button class="btn small" id="downloadBtn">Download HTML</button>
      <button class="btn small" id="printBtn">Print</button>
    </div>
  </header>
  <div class="container">
    <nav aria-label="Table of contents">
      <h2>Contents</h2>
      <ul>
        <li><a href="#intro">Introduction</a></li>
        <li><a href="#objective">Objective</a></li>
        <li><a href="#step1">Step 1 — Data Preparation</a></li>
        <li><a href="#step2">Step 2 — Quality Check (FastQC)</a></li>
        <li><a href="#step3">Step 3 — Read Trimming (Trim Galore)</a></li>
        <li><a href="#step4">Step 4 — Reference Alignment (BWA)</a></li>
        <li><a href="#step5">Step 5 — BAM Processing (SAMtools)</a></li>
        <li><a href="#step6">Step 6 — Variant Calling (BCFtools)</a></li>
        <li><a href="#step7">Step 7 — Variant Annotation (SnpEff)</a></li>
        <li><a href="#references">Tool Documentation & Cross-References</a></li>
        <li><a href="#end">End of Tutorial</a></li>
      </ul>
    </nav>

    <main>
      <section id="intro">
        <h2 class="section-title">Introduction</h2>
        <p class="lead">Next-generation sequencing (NGS) technology has transformed disease surveillance and diagnostics. This tutorial shows how to perform reference-based mapping and variant calling of SARS-CoV-2 data on <strong>ICE-Cloud</strong>, using common command-line tools. Each executable code block has a copy button for convenience.</p>
      </section>

      <section id="objective">
        <h2 class="section-title">Objective</h2>
        <p>Perform quality assessment, trimming, alignment, variant calling, annotation, and basic interpretation of SARS-CoV-2 sequence data on ICE-cloud.</p>
      </section>

      <section id="step1">
        <h2 class="section-title">Step 1 — Data Preparation</h2>
        <p class="meta">Start an <strong>ICE job container</strong> with the <code class="inline">sratoolkit</code> image. Allocate at least <strong>2 CPUs</strong> and <strong>8 GB</strong> memory. Connect to the container terminal as shown in the platform UI.</p>

        <div class="card">
          <strong>Commands</strong>
          <div class="cmd-wrap">
            <button class="copy-btn" data-target="cmd1">Copy</button>
            <pre id="cmd1">prefetch SRR15571424
fasterq-dump SRR15571424 -S -e 2
gzip SRR15571424_1.fastq
gzip SRR15571424_2.fastq</pre>
          </div>
          <p class="footnote">Notes: <code>prefetch</code> downloads the SRA file; <code>fasterq-dump</code> converts to FASTQ. See tool docs below for options.</p>
        </div>
      </section>

      <section id="step2">
        <h2 class="section-title">Step 2 — Quality Check (FastQC)</h2>
        <p class="meta">Launch a container with the <code class="inline">fastqc</code> image (2 CPU, 8 GB). Run FastQC on paired FASTQ files to get QC reports.</p>

        <div class="card">
          <strong>Commands</strong>
          <div class="cmd-wrap">
            <button class="copy-btn" data-target="cmd2">Copy</button>
            <pre id="cmd2">cp -r /drive/public/ICE_Workshop/AIC_CCMB/var_call_tutorial .
cd var_call_tutorial
fastqc --threads 5 SRR15571424_1.fastq.gz SRR15571424_2.fastq.gz
ls -lrth</pre>
          </div>
          <p class="footnote">Tip: FastQC produces an HTML report for each FASTQ file — open it locally or via ICE file browser.</p>
        </div>
      </section>

      <section id="step3">
        <h2 class="section-title">Step 3 — Read Trimming (Trim Galore)</h2>
        <p class="meta">Launch a <code class="inline">trim_galore</code> container and run paired-end trimming with FastQC on trimmed output.</p>

        <div class="card">
          <strong>Commands</strong>
          <div class="cmd-wrap">
            <button class="copy-btn" data-target="cmd3">Copy</button>
            <pre id="cmd3">cd var_call_tutorial
trim_galore --fastqc --paired SRR15571424_1.fastq.gz SRR15571424_2.fastq.gz
ls -lrth</pre>
          </div>
          <p class="footnote">Trim Galore wraps Cutadapt and FastQC. Inspect trimmed files which usually end with <code>_val_1.fq.gz</code> and <code>_val_2.fq.gz</code>.</p>
        </div>
      </section>

      <section id="step4">
        <h2 class="section-title">Step 4 — Reference Alignment (BWA)</h2>
        <p class="meta">Use <code class="inline">bwa</code> to index the SARS-CoV-2 reference and run <code>bwa mem</code> for paired-end alignment. Include read group (RG) tags for downstream tools.</p>

        <div class="card">
          <strong>Commands</strong>
          <div class="cmd-wrap">
            <button class="copy-btn" data-target="cmd4">Copy</button>
            <pre id="cmd4">cd var_call_tutorial
bwa index MN908947.3.fna
bwa mem -t 2 -R "@RG\tID:SRR15571424\tSM:SRR15571424\tPL:illumina\tLB:lib1\tPU:unit1" -V -M -o SRR15571424.sam MN908947.3.fna SRR15571424_1_val_1.fq.gz SRR15571424_2_val_2.fq.gz
ls -lrth</pre>
          </div>
          <p class="footnote">Important: Use the trimmed FASTQ files as input. The <code>-R</code> string must escape tabs as shown.</p>
        </div>
      </section>

      <section id="step5">
        <h2 class="section-title">Step 5 — BAM Processing (SAMtools)</h2>
        <p class="meta">Convert SAM → BAM, sort, index, and generate mapped/unmapped subsets and flagstat summary with <code class="inline">samtools</code>.</p>

        <div class="card">
          <strong>Commands</strong>
          <div class="cmd-wrap">
            <button class="copy-btn" data-target="cmd5">Copy</button>
            <pre id="cmd5">samtools view -S -b SRR15571424.sam -o SRR15571424.bam --threads 5
samtools sort SRR15571424.bam -o SRR15571424_sorted.bam --threads 5
samtools index SRR15571424_sorted.bam
samtools view -b -F 4 SRR15571424_sorted.bam > SRR15571424_mapped.bam
samtools view -b -f 4 SRR15571424_sorted.bam > SRR15571424_unmapped.bam
samtools flagstat SRR15571424_sorted.bam
ls -lrth</pre>
          </div>
          <p class="footnote">Note: Use adequate threads on the container. Keep final sorted BAM + index as result files.</p>
        </div>
      </section>

      <section id="step6">
        <h2 class="section-title">Step 6 — Variant Calling (BCFtools)</h2>
        <p class="meta">Generate a BCF via <code class="inline">bcftools mpileup</code> and call variants with <code class="inline">bcftools call</code>. For SARS-CoV-2 set ploidy to 1 (haploid viral genome).</p>

        <div class="card">
          <strong>Commands</strong>
          <div class="cmd-wrap">
            <button class="copy-btn" data-target="cmd6">Copy</button>
            <pre id="cmd6">bcftools mpileup -f MN908947.3.fna -Ou --threads 5 SRR15571424_sorted.bam -o SRR15571424.bcf
bcftools call -mv -Ov --ploidy 1 --threads 2 SRR15571424.bcf -o SRR15571424.vcf
ls -lrth</pre>
          </div>
          <p class="footnote">Tip: Consider additional filtering (QUAL, DP) depending on coverage and downstream needs.</p>
        </div>
      </section>

      <section id="step7">
        <h2 class="section-title">Step 7 — Variant Annotation (SnpEff)</h2>
        <p class="meta">Build an annotation database (if needed) and annotate the VCF using <code class="inline">snpEff</code>. Produce CSV/HTML stats and an annotated VCF.</p>

        <div class="card">
          <strong>Commands</strong>
          <div class="cmd-wrap">
            <button class="copy-btn" data-target="cmd7">Copy</button>
            <pre id="cmd7">/snpEff/scripts/buildDbNcbi.sh MN908947.3
java -jar /snpEff/snpEff.jar ann -v MN908947.3 SRR15571424.vcf -csvStats SRR15571424_stat.csv -htmlStats SRR15571424_stat.html > SRR15571424_ann.vcf

# quick filters
cat SRR15571424_ann.vcf | grep "missense_variant"
cat SRR15571424_ann.vcf | grep "MODERATE"
cat SRR15571424_ann.vcf | grep "LOW"</pre>
          </div>
          <p class="footnote">SnpEff config and genome setup may require GFF/GTF annotations and FASTA files. Use pre-built databases when available.</p>
        </div>
      </section>

      <section id="references">
        <h2 class="section-title">Tool Documentation & Cross-References</h2>
        <p class="lead">Official documentation and helpful cross-reference pages for each tool used in this tutorial.</p>

        <div class="doc-links">
          <div class="card">
            <strong>SRA Toolkit (prefetch, fasterq-dump)</strong>
            <p class="footnote"><a class="external" href="https://github.com/ncbi/sra-tools/wiki/08.-prefetch-and-fasterq-dump" target="_blank">SRA-Tools: prefetch & fasterq-dump (GitHub Wiki)</a></p>
            <p class="footnote"><a class="external" href="https://www.ncbi.nlm.nih.gov/sra/docs/sradownload/" target="_blank">NCBI SRA Download guide</a></p>
          </div>

          <div class="card">
            <strong>FastQC</strong>
            <p class="footnote"><a class="external" href="https://www.bioinformatics.babraham.ac.uk/projects/fastqc/" target="_blank">FastQC official page (Babraham)</a></p>
          </div>

          <div class="card">
            <strong>Trim Galore!</strong>
            <p class="footnote"><a class="external" href="https://www.bioinformatics.babraham.ac.uk/projects/trim_galore/" target="_blank">Trim Galore — User Guide</a></p>
            <p class="footnote"><a class="external" href="https://github.com/FelixKrueger/TrimGalore" target="_blank">Trim Galore (GitHub)</a></p>
          </div>

          <div class="card">
            <strong>BWA</strong>
            <p class="footnote"><a class="external" href="https://bio-bwa.sourceforge.net/bwa.shtml" target="_blank">BWA manual page</a></p>
            <p class="footnote"><a class="external" href="https://github.com/lh3/bwa" target="_blank">BWA (GitHub)</a></p>
          </div>

          <div class="card">
            <strong>SAMtools & HTSlib</strong>
            <p class="footnote"><a class="external" href="https://www.htslib.org/" target="_blank">HTSlib / Samtools documentation</a></p>
          </div>

          <div class="card">
            <strong>BCFtools</strong>
            <p class="footnote"><a class="external" href="https://samtools.github.io/bcftools/bcftools.html" target="_blank">BCFtools manual</a></p>
            <p class="footnote"><a class="external" href="https://samtools.github.io/bcftools/howtos/variant-calling.html" target="_blank">BCFtools variant calling howto</a></p>
          </div>

          <div class="card">
            <strong>SnpEff</strong>
            <p class="footnote"><a class="external" href="https://pcingola.github.io/SnpEff/" target="_blank">SnpEff documentation & commands</a></p>
            <p class="footnote"><a class="external" href="https://pcingola.github.io/SnpEff/snpeff/build_db/" target="_blank">SnpEff — Building databases</a></p>
          </div>
        </div>

        <div class="meta" style="margin-top:14px">Tip: Click any tool link to open the official docs in a new tab. Use the copy buttons to paste commands directly into your ICE terminal.</div>
      </section>

      <section id="end">
        <h2 class="section-title">End of Tutorial</h2>
        <p class="lead">You now have a complete, copy-ready SARS-CoV-2 variant calling tutorial suitable for ICE-Cloud. Feel free to edit command examples, add additional filtering steps, or request a multi-sample workflow version.</p>
      </section>

      <footer>
        <div>Created for ICE-Cloud users — includes copy-to-clipboard for executable commands and cross-references to official tool documentation.</div>
      </footer>
    </main>
  </div>

  <script>
    // Copy buttons
    document.querySelectorAll('.copy-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-target');
        const text = document.getElementById(id).innerText;
        try{
          await navigator.clipboard.writeText(text);
          btn.innerText = 'Copied';
          setTimeout(()=> btn.innerText = 'Copy',1500);
        }catch(e){
          alert('Copy failed — select and copy manually.');
        }
      });
    });

    // Download HTML
    document.getElementById('downloadBtn').addEventListener('click', ()=>{
      const blob = new Blob([document.documentElement.outerHTML], {type:'text/html'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'sarscov2_variant_calling_icecloud_tutorial.html';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // Print
    document.getElementById('printBtn').addEventListener('click', ()=> window.print());
  </script>
</body>
</html>

